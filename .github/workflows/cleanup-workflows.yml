name: Cleanup Failed Workflows

on:
  workflow_dispatch:

permissions:
  actions: write
  contents: read

jobs:
  cleanup:
    runs-on: ubuntu-latest
    steps:
      - name: Delete failed workflow runs
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          echo "üßπ Starting cleanup of failed, cancelled and skipped workflow runs..."
          echo ""
          
          # Get all workflow runs
          OWNER="${{ github.repository_owner }}"
          REPO="${{ github.event.repository.name }}"
          
          deleted=0
          page=1
          
          while true; do
            echo "üìÑ Fetching page $page..."
            
            # Get workflow runs (all statuses)
            response=$(gh api \
              -H "Accept: application/vnd.github+json" \
              -H "X-GitHub-Api-Version: 2022-11-28" \
              "/repos/$OWNER/$REPO/actions/runs?per_page=100&page=$page" 2>&1)
            
            if [ $? -ne 0 ]; then
              echo "‚ùå API call failed: $response"
              break
            fi
            
            # Extract run IDs and conclusions
            runs=$(echo "$response" | jq -r '.workflow_runs[] | select(.conclusion == "failure" or .conclusion == "cancelled" or .conclusion == "skipped") | "\(.id)|\(.name)|\(.conclusion)"')
            
            if [ -z "$runs" ]; then
              echo "‚úÖ No more runs to delete on page $page"
              break
            fi
            
            # Delete each run
            while IFS='|' read -r run_id name conclusion; do
              echo "üóëÔ∏è  Deleting [$conclusion] $name (ID: $run_id)..."
              
              delete_response=$(gh api \
                --method DELETE \
                -H "Accept: application/vnd.github+json" \
                -H "X-GitHub-Api-Version: 2022-11-28" \
                "/repos/$OWNER/$REPO/actions/runs/$run_id" 2>&1)
              
              if [ $? -eq 0 ]; then
                echo "   ‚úÖ Deleted successfully"
                ((deleted++))
              else
                echo "   ‚ùå Failed: $delete_response"
              fi
              
              # Rate limiting
              sleep 0.1
            done <<< "$runs"
            
            ((page++))
            
            # Safety limit
            if [ $page -gt 50 ]; then
              echo "‚ö†Ô∏è  Reached page limit (50), stopping..."
              break
            fi
          done
          
          echo ""
          echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
          echo "‚úÖ Cleanup completed!"
          echo "üìä Deleted $deleted workflow runs"
          echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
