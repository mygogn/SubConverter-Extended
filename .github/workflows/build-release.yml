name: Build Release Artifacts

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:

permissions:
  contents: write

concurrency:
  group: release-${{ github.ref_name }}
  cancel-in-progress: true

jobs:
  prepare:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
    steps:
      - name: Extract version from tag
        id: version
        run: |
          if [[ "${{ github.ref }}" == refs/tags/* ]]; then
            VERSION="${GITHUB_REF#refs/tags/}"
          else
            VERSION="dev-$(git rev-parse --short HEAD)"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Release version: $VERSION"

  build-linux-glibc:
    runs-on: ${{ matrix.platform.runner }}
    needs: prepare
    strategy:
      matrix:
        platform:
          - arch: amd64
            runner: ubuntu-latest
          - arch: arm64
            runner: ubuntu-24.04-arm
          - arch: armv7
            runner: ubuntu-24.04-arm
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Set up QEMU (for armv7)
        if: matrix.platform.arch == 'armv7'
        uses: docker/setup-qemu-action@v3
        with:
          platforms: arm

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # æž„å»ºåˆ° builder é˜¶æ®µï¼ˆä¸æŽ¨é€ï¼‰
      - name: Build to builder stage
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./Dockerfile
          load: true
          tags: subconverter-temp:builder
          target: builder
          platforms: linux/${{ matrix.platform.arch }}
          build-args: |
            THREADS=4
            VERSION=${{ needs.prepare.outputs.version }}
          cache-from: type=gha,scope=subconverter-glibc-${{ matrix.platform.arch }}
          cache-to: type=gha,mode=max,scope=subconverter-glibc-${{ matrix.platform.arch }}

      # æå–äºŒè¿›åˆ¶å’Œèµ„æºæ–‡ä»¶
      - name: Extract binaries
        run: |
          CONTAINER_ID=$(docker create subconverter-temp:builder)
          docker cp $CONTAINER_ID:/src/subconverter ./subconverter
          docker cp $CONTAINER_ID:/src/base ./base
          docker rm $CONTAINER_ID
          chmod +x subconverter

      # æ‰“åŒ…ä¸º .tar.gz
      - name: Package Linux release
        run: |
          mkdir -p SubConverter-Extended
          mv subconverter SubConverter-Extended/
          mv base SubConverter-Extended/
          
          # åˆ›å»ºå¯åŠ¨è„šæœ¬
          cat > SubConverter-Extended/start.sh << 'EOF'
          #!/bin/bash
          CONFIG_DIR="/etc/SubConverter-Extended"
          sudo mkdir -p "$CONFIG_DIR"
          sudo cp -n base/pref.example.toml "$CONFIG_DIR/pref.toml" 2>/dev/null || true
          ./subconverter -f "$CONFIG_DIR/pref.toml"
          EOF
          chmod +x SubConverter-Extended/start.sh
          
          # åˆ›å»º README
          cat > SubConverter-Extended/README.txt << 'EOF'
          SubConverter-Extended - Linux (glibc) Release

          Installation:
          1. Extract this archive
          2. Run ./start.sh to start the service
          
          The configuration file will be created at /etc/SubConverter-Extended/pref.toml

          For more information, visit:
          https://github.com/Aethersailor/SubConverter-Extended
          EOF
          
          tar -czf SubConverter-Extended-${{ needs.prepare.outputs.version }}-linux-${{ matrix.platform.arch }}.tar.gz SubConverter-Extended

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: linux-glibc-${{ matrix.platform.arch }}
          path: SubConverter-Extended-*.tar.gz

  build-linux-musl:
    runs-on: ${{ matrix.platform.runner }}
    needs: prepare
    strategy:
      matrix:
        platform:
          - arch: amd64
            runner: ubuntu-latest
          - arch: arm64
            runner: ubuntu-24.04-arm
          - arch: armv7
            runner: ubuntu-24.04-arm
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Set up QEMU (for armv7)
        if: matrix.platform.arch == 'armv7'
        uses: docker/setup-qemu-action@v3
        with:
          platforms: arm

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # ä½¿ç”¨ Alpine åŸºç¡€é•œåƒæž„å»º
      - name: Build Alpine binary
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./Dockerfile.alpine
          load: true
          tags: subconverter-alpine:builder
          target: builder
          platforms: linux/${{ matrix.platform.arch }}
          build-args: |
            THREADS=4
            VERSION=${{ needs.prepare.outputs.version }}
          cache-from: type=gha,scope=subconverter-musl-${{ matrix.platform.arch }}
          cache-to: type=gha,mode=max,scope=subconverter-musl-${{ matrix.platform.arch }}

      # æå–äºŒè¿›åˆ¶
      - name: Extract Alpine binary
        run: |
          CONTAINER_ID=$(docker create subconverter-alpine:builder)
          docker cp $CONTAINER_ID:/src/subconverter ./subconverter
          docker cp $CONTAINER_ID:/src/base ./base
          docker rm $CONTAINER_ID
          chmod +x subconverter

      # æ‰“åŒ…
      - name: Package Alpine release
        run: |
          mkdir -p SubConverter-Extended
          mv subconverter SubConverter-Extended/
          mv base SubConverter-Extended/
          
          # åˆ›å»ºå¯åŠ¨è„šæœ¬ï¼ˆä¸Ž glibc ç‰ˆæœ¬ç›¸åŒï¼‰
          cat > SubConverter-Extended/start.sh << 'EOF'
          #!/bin/sh
          CONFIG_DIR="/etc/SubConverter-Extended"
          mkdir -p "$CONFIG_DIR" 2>/dev/null || sudo mkdir -p "$CONFIG_DIR"
          cp -n base/pref.example.toml "$CONFIG_DIR/pref.toml" 2>/dev/null || sudo cp -n base/pref.example.toml "$CONFIG_DIR/pref.toml"
          ./subconverter -f "$CONFIG_DIR/pref.toml"
          EOF
          chmod +x SubConverter-Extended/start.sh
          
          # åˆ›å»º README
          cat > SubConverter-Extended/README.txt << 'EOF'
          SubConverter-Extended - Alpine (musl) Release

          This is a statically-linked musl build, compatible with Alpine Linux
          and other musl-based distributions.

          Installation:
          1. Extract this archive
          2. Run ./start.sh to start the service
          
          The configuration file will be created at /etc/SubConverter-Extended/pref.toml

          For more information, visit:
          https://github.com/Aethersailor/SubConverter-Extended
          EOF
          
          tar -czf SubConverter-Extended-${{ needs.prepare.outputs.version }}-alpine-${{ matrix.platform.arch }}.tar.gz SubConverter-Extended

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: alpine-${{ matrix.platform.arch }}
          path: SubConverter-Extended-*.tar.gz

  build-windows:
    runs-on: ubuntu-latest
    needs: prepare
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Cache vcpkg
        uses: actions/cache@v4
        with:
          path: vcpkg
          key: vcpkg-mingw-${{ hashFiles('vcpkg.json') }}
          restore-keys: |
            vcpkg-mingw-

      - name: Install MinGW-w64 toolchain
        run: |
          sudo apt-get update
          sudo apt-get install -y mingw-w64 cmake ninja-build

      - name: Setup vcpkg
        run: |
          if [ ! -d "vcpkg" ]; then
            git clone https://github.com/microsoft/vcpkg.git
            cd vcpkg && ./bootstrap-vcpkg.sh
          fi

      - name: Install Windows dependencies
        run: |
          cd vcpkg
          ./vcpkg install \
            curl:x64-mingw-static \
            pcre2:x64-mingw-static \
            yaml-cpp:x64-mingw-static \
            rapidjson:x64-mingw-static

      - name: Build Windows binary
        run: |
          mkdir build && cd build
          cmake -GNinja \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_TOOLCHAIN_FILE=../vcpkg/scripts/buildsystems/vcpkg.cmake \
            -DVCPKG_TARGET_TRIPLET=x64-mingw-static \
            -DCMAKE_CXX_COMPILER=x86_64-w64-mingw32-g++ \
            -DCMAKE_C_COMPILER=x86_64-w64-mingw32-gcc \
            ..
          
          ninja -j $(nproc)

      # æ‰“åŒ…ä¾¿æºç‰ˆ
      - name: Package portable version
        run: |
          mkdir SubConverter-Extended
          cp build/subconverter.exe SubConverter-Extended/
          cp -r base SubConverter-Extended/
          
          # åˆ›å»º README
          cat > SubConverter-Extended/README.txt << 'EOF'
          SubConverter-Extended - Windows Portable Edition

          Installation:
          1. Extract this archive
          2. Run subconverter.exe
          
          The configuration file (pref.toml) will be automatically created
          in the same directory on first run.

          For more information, visit:
          https://github.com/Aethersailor/SubConverter-Extended
          EOF
          
          zip -r SubConverter-Extended-${{ needs.prepare.outputs.version }}-windows-portable.zip SubConverter-Extended

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: windows-x64
          path: SubConverter-Extended-*.zip

  create-release:
    runs-on: ubuntu-latest
    needs: [prepare, build-linux-glibc, build-linux-musl, build-windows]
    if: startsWith(github.ref, 'refs/tags/')
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            artifacts/linux-glibc-*/*.tar.gz
            artifacts/alpine-*/*.tar.gz
            artifacts/windows-x64/*.zip
          body: |
            ## ðŸ“¦ Downloads

            ### Linux (Debian/Ubuntu - glibc)
            - **amd64**: `SubConverter-Extended-${{ needs.prepare.outputs.version }}-linux-amd64.tar.gz`
            - **arm64**: `SubConverter-Extended-${{ needs.prepare.outputs.version }}-linux-arm64.tar.gz`
            - **armv7**: `SubConverter-Extended-${{ needs.prepare.outputs.version }}-linux-armv7.tar.gz`

            ### Linux (Alpine - musl)
            - **amd64**: `SubConverter-Extended-${{ needs.prepare.outputs.version }}-alpine-amd64.tar.gz`
            - **arm64**: `SubConverter-Extended-${{ needs.prepare.outputs.version }}-alpine-arm64.tar.gz`
            - **armv7**: `SubConverter-Extended-${{ needs.prepare.outputs.version }}-alpine-armv7.tar.gz`

            ### Windows (x86_64)
            - **ä¾¿æºç‰ˆ**: `SubConverter-Extended-${{ needs.prepare.outputs.version }}-windows-portable.zip`

            ---

            ## ðŸ“„ Installation

            ### Linux (Debian/Ubuntu)
            ```bash
            tar -xzf SubConverter-Extended-${{ needs.prepare.outputs.version }}-linux-amd64.tar.gz
            cd SubConverter-Extended
            ./start.sh
            ```

            ### Alpine Linux
            ```bash
            tar -xzf SubConverter-Extended-${{ needs.prepare.outputs.version }}-alpine-amd64.tar.gz
            cd SubConverter-Extended
            ./start.sh
            ```

            ### Windows
            1. Extract the `.zip` file
            2. Run `subconverter.exe`

            Configuration file will be auto-generated on first run.

            ---

            **Full Changelog**: https://github.com/Aethersailor/SubConverter-Extended/compare/${{ github.event.before }}...${{ github.ref_name }}
